<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.2" reference="ActiveDirectory.Code.Main" locale="">
  <web>ActiveDirectory.Code</web>
  <name>Main</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1476442561000</creationDate>
  <parent>ActiveDirectory.Code.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1476443923000</date>
  <contentUpdateDate>1476442760000</contentUpdateDate>
  <version>1.1</version>
  <title>Main</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
#macro(displaySelectField $prop $default)
  #set ($value = $configDoc.getValue($prop.name))
  #set ($options = [])
  #if ($prop.classType == 'String' || $prop.classType == 'TextArea')
    $configDoc.display($prop.name, 'edit', $configObj).replaceAll('(^..html.*?}})|(../html..$)', '')
  #else
    #if ($prop.classType == 'Boolean')
      #set ($discard = $options.add({'value': 1, 'label': 'yes'}))
      #set ($discard = $options.add({'value': 0, 'label': 'no'}))
    #else
      #foreach($v in $prop.listValues)
        #set ($discard = $options.add({'value': $v, 'label': "XWiki.XWikiPreferences_${prop.name}_${v}"}))
      #end
    #end
    &lt;select name="XWiki.XWikiPreferences_0_${prop.name}" id="XWiki.XWikiPreferences_0_${prop.name}"&gt;
      #if ("$!default" != '')
        &lt;option value=""&gt;---&lt;/option&gt;
      #end
      #foreach ($option in $options)
        #if ($option.value != '---')
          &lt;option value="$option.value" #if($value == $option.value)selected="selected"#end&gt;
            $services.localization.render($option.label)
            #if ($default == $option.value)
              $services.localization.render('activeDirectory.default')
            #end
          &lt;/option&gt;
        #end
      #end
    &lt;/select&gt;
  #end
#end
#macro (displayMainForm)
  #set ($discard = $xwiki.jsx.use('ActiveDirectory.WebHome'))
  #set ($discard = $xwiki.ssx.use('ActiveDirectory.WebHome'))
  #set ($configClassName = 'XWiki.XWikiPreferences')
  #set ($configClass = $xwiki.getClass($configClassName))
  #set ($configDoc = $xwiki.getDocument('ActiveDirectory.Code.ActiveDirectoryConfig'))
  ## Create the config doc if it doesn't exist
  #if ($configDoc.isNew())
    #set ($discard = $configDoc.newObject($configClassName))
    #set ($discard = $configDoc.setHidden(true))
    #set ($discard = $configDoc.save($services.localization.render('activeDirecfory.config.initializationComment'), 'true'))
  #end
  #set ($configObj = $configDoc.getObject($configClassName))
  #set ($params = {
    'activeDirectoryConnection': {'ldap_server'    : '127.0.0.1',
                                  'ldap_port'      : 389,
                                  'ldap_bind_DN'   : '',
                                  'ldap_bind_pass' : ''},
    'activeDirectoryConfiguration' : {'ldap_base_DN'        : ''},
    'activeDirectoryConfigurationAdvanced' : {'ldap'                       : '1',
                                              'ldap_UID_attr'              : 'sAMAccountName',
                                              'ldap_fields_mapping'        : '',
                                              'ldap_group_mapping'         : '',
                                              'ldap_user_group'            : '',
                                              'ldap_exclude_group'         : '',
                                              'ldap_trylocal'              : '1',
                                              'ldap_update_user'           : '0',
                                              'ldap_update_photo'          : '0',
                                              'ldap_groupcache_expiration' : 21600,
                                              'ldap_mode_group_sync'       : 'always'}
  })
  ## TODO: Transform the maps from $params in arrays holding
  ## only property names when https://jira.xwikisas.com/browse/ADAPP-30 is implemented
   #if ("$!section" != '')
    {{html clean="false"}}
      #set($formId = "${section.toLowerCase()}_${configClassName}")
      &lt;form id="$formId" method="post" action="$xwiki.getURL($configDoc, 'saveandcontinue')" onsubmit="cancelCancelEdit()" class="xform half"&gt;
        #foreach ($entry in $params.entrySet())
          #set ($fields = $entry.value)
          &lt;fieldset class="$entry.key"&gt;
          ## If there is only one section, don't display the legend
          #if ($params.size() &gt; 1)
            &lt;legend&gt;$services.localization.render("admin.$entry.key")
              #if ($entry.key == 'activeDirectoryConfigurationAdvanced')
                &lt;a id="advancedConfigShow"&gt;$services.localization.render('admin.activeDirectoryConfigurationAdvanced.show')&lt;/a&gt;
                &lt;a id="advancedConfigHide"&gt;$services.localization.render('admin.activeDirectoryConfigurationAdvanced.hide')&lt;/a&gt;
              #end
            &lt;/legend&gt;
          #end
          &lt;dl&gt;
            #foreach ($field in $fields.entrySet())
              #set ($prop = $configClass.get($field.key))
              #set ($title = $services.localization.render("${configObj.xWikiClass.name}_${prop.name}"))
              #set ($hint = $services.localization.render("${configObj.xWikiClass.name}_${prop.name}.hint"))
              &lt;dt&gt;
                &lt;label for="${configClassName}_${configObj.number}_${prop.name}" class="$prop.name"&gt;$title&lt;/label&gt;
                #if ($hint)&lt;span class="xHint"&gt;$hint&lt;/span&gt;#end
              &lt;/dt&gt;
              &lt;dd&gt;
                #displaySelectField($prop $field.value)
                ## TODO: when https://jira.xwikisas.com/browse/ADAPP-30 is implemented, replace $field.value
                ## with the default taken from the script service
              &lt;dt&gt;
            #end
          &lt;/dl&gt;
          &lt;/fieldset&gt;
        #end
        &lt;div class="hidden"&gt;
          &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
          &lt;input type="hidden" name="xcontinue" value="$xwiki.getURL($currentDoc, 'admin', "editor=${escapetool.url(${editor})}&amp;section=${escapetool.url(${section})}&amp;space=${escapetool.url(${currentSpace})}")" /&gt;
          &lt;input type="hidden" name="xredirect" value="$xwiki.getURL($currentDoc, 'admin', "editor=${escapetool.url(${editor})}&amp;section=${escapetool.url(${section})}&amp;a;space=${escapetool.url(${currentSpace})}")" /&gt;
          &lt;input type="hidden" name="classname" value="$configClassName" /&gt;
        &lt;/div&gt;
        &lt;input class="button" type="submit" name="formactionsac" value="$services.localization.render('admin.save')" /&gt;
      &lt;/form&gt;
    {{/html}}
  #end
#end
##
#if ($services.ldap)
  #if ($services.ldap.isXWikiLDAPAuthenticator())
    #if ($request.action_resetGroupCache)
      #set ($discard = $services.ldap.resetGroupCache())
      {{success}}$services.localization.render('activeDirectory.success.resetGroupCache'){{/success}}
    #end
    #displayMainForm($configClassName)
    {{html clean="false"}}
      &lt;form method="post" class="xform half" action="${escapetool.xml($xwiki.requestURL)}" enctype="multipart/form-data"&gt;
        &lt;fieldset class='activeDirectoryMiscellaneous'&gt;
          &lt;legend&gt;$services.localization.render('admin.activeDirectoryMiscellaneous')&lt;/legend&gt;
        &lt;/fieldset&gt;
        &lt;input name="action_resetGroupCache" value="${escapetool.xml($services.localization.render('activeDirectory.resetGroupCache.submit'))}" class="button" type="submit"&gt;
      &lt;/form&gt;
    {{/html}}
  #else
    {{warning}}
      $services.localization.render('activeDirectory.warning.ldapAuthenticationIsNotEnabled', ['webapps/xwiki/WEB-INF/xwiki.cfg'])
      xwiki.authentication.authclass=org.xwiki.contrib.ldap.XWikiLDAPAuthServiceImpl
      xwiki.authentication.ldap.trylocal=1
    {{/warning}}
  #end
#else 
  {{error}}$services.localization.render('activeDirectory.error.missingLdapService'){{/error}}
#end
{{/velocity}}</content>
</xwikidoc>
